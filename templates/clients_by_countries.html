{% extends "layout.html" %}
{% block title %}Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙÙŠ {{ countries.name }}{% endblock %}

{% block content %}

<div class="container mx-auto px-4 py-6">
   

   <div class="flex items-center gap-2">
  <img src="{{ url_for('static', filename='flag/' ~ countries.flag_filename) }}"
       alt="Ø¹Ù„Ù… {{ countries.name }}"
       class="w-8 h-5 object-contain rounded border" />
  <span class="font-semibold text-lg">{{ countries.name }}</span>
</div>

     


  <!-- Modal Ø§Ù„Ø­Ø°Ù -->
    <div class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50" id="deleteModal">
        <div class="bg-white rounded-lg shadow-md p-6 w-full max-w-md">
            <h3 class="text-xl font-bold text-red-600 mb-4">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù</h3>
            <p class="text-gray-700 mb-4">
                Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø­Ø°Ù <span class="font-semibold text-red-700" id="clientNameToDelete"></span>ØŸ<br>
                <small class="text-gray-500">Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡.</small>
            </p>
            <div class="flex justify-end gap-2">
                <button onclick="toggleModal(false)" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">Ø¥Ù„ØºØ§Ø¡</button>
                <button id="confirmDeleteBtn" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°Ù</button>
            </div>
        </div>
    </div>

    {% if clients %}
    <!-- ğŸ” Ø§Ù„Ø¨Ø­Ø« + â†•ï¸ Ø§Ù„ØªØ±ØªÙŠØ¨ -->
<form method="get" class="mb-6 flex flex-wrap items-center justify-between gap-4">

  <!-- ğŸ” Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø¨Ø­Ø« -->
  <div class="flex-1">
    <input type="text" name="search" placeholder="ğŸ” Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…"
           value="{{ search }}" 
           class="w-full px-4 py-2 border rounded-xl shadow-sm focus:outline-none focus:ring focus:border-primary">
  </div>

  <!-- â¬‡ï¸ Ø§Ø®ØªÙŠØ§Ø± Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØªØ±ØªÙŠØ¨ -->
  <div>
    <select name="sort_by" onchange="this.form.submit()"
            class="px-4 py-2 border rounded-xl shadow-sm focus:outline-none focus:ring focus:border-primary">
      <option value="">Ø§Ù„ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ ...</option>
      <option value="visa_type_asc" {% if sort_by == 'visa_type_asc' %}selected{% endif %}>Ù†ÙˆØ¹ Ø§Ù„ÙÙŠØ²Ø§</option>
      <option value="client_type_asc" {% if sort_by == 'client_type_asc' %}selected{% endif %}>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…ÙŠÙ„</option>
      <option value="date_asc" {% if sort_by == 'date_asc' %}selected{% endif %}>Ø£Ù‚Ø±Ø¨ ØªØ§Ø±ÙŠØ® Ø¯ÙØ¹</option>
      <option value="date_desc" {% if sort_by == 'date_desc' %}selected{% endif %}>Ø£Ø¨Ø¹Ø¯ ØªØ§Ø±ÙŠØ® Ø¯ÙØ¹</option>
    </select>
  </div>

</form>

    <!-- ğŸ“Š Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ -->
   <div class="mb-4">
  <div class="inline-flex items-center gap-2 bg-blue-50 text-blue-800 px-4 py-2 rounded-lg shadow-sm text-sm">
    ğŸ‘¥ Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡: <span class="font-bold">{{ total_clients }}</span>
  </div>
</div>

   <!--  Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡-    -->
<div class="overflow-x-auto rounded-lg shadow ring-1 ring-gray-200">
    <table class="min-w-full divide-y divide-gray-200 text-right text-sm">
        <thead class="bg-gray-50 text-gray-700 text-sm font-semibold sticky top-0 z-10">
            <tr>
                <th class="px-5 py-3">ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…</th>
                <th class="px-5 py-3">ğŸ‘¥ Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                <th class="px-5 py-3">ğŸ« Ù†ÙˆØ¹ Ø§Ù„ÙÙŠØ²Ø§</th>
                <th class="px-5 py-3">ğŸ’¼ ØªØ§Ø±ÙŠØ® Ø¯ÙØ¹ Ø§Ù„Ù…Ù„Ù</th>
                <th class="px-5 py-3">ğŸ’° Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ©</th>
                <th class="px-5 py-3">âš™ï¸ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
        </thead>
        
        <tbody class="bg-white divide-y divide-gray-100">
            {% for client in clients %}
                {% set highlight = '' %}
                {% if client.file_payment_date %}
                    {% set days_left = (client.file_payment_date - current_date).days %}
                    {% if days_left <= 5 %}
                        {% set highlight = 'bg-red-50' %}
                    {% elif days_left <= 10 %}
                        {% set highlight = 'bg-yellow-50' %}
                    {% endif %}
                {% endif %}
                <tr id="client-{{ client.id }}" class="hover:bg-gray-50 transition {{ highlight }}">
                    <!-- Ø§Ù„Ø§Ø³Ù…: Ù„Ù‚Ø¨ Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© Ø¥Ø°Ø§ Ø¹Ø§Ø¦Ù„ÙŠ -->
                    <td class="px-5 py-3 text-lg font-xl text-gray-800 whitespace-nowrap">
    {{ client.full_name | upper }}
</td>


                    <!-- Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…ÙŠÙ„ -->
                    <td class="px-5 py-3 text-gray-600 whitespace-nowrap">
                        {{ 'Ø¹Ø§Ø¦Ù„ÙŠ' if client.client_type == 'family' else 'ÙØ±Ø¯ÙŠ' }}
                    </td>

                    <!-- Ù†ÙˆØ¹ Ø§Ù„ÙÙŠØ²Ø§ -->
                    <td class="px-5 py-3 text-gray-600 whitespace-nowrap">
                        {{ client.visa_type or 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}
                    </td>

                    <!-- ØªØ§Ø±ÙŠØ® Ø¯ÙØ¹ Ø§Ù„Ù…Ù„Ù -->
                    <td class="px-5 py-3 text-gray-600 whitespace-nowrap">
                        {{ client.file_payment_date.strftime('%Y-%m-%d') if client.file_payment_date else 'ØºÙŠØ± Ù…ØªÙˆÙØ±' }}
                    </td>

                    <!-- Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ© -->
                    <td class="px-5 py-3 font-semibold whitespace-nowrap">
                        {% if client.amount_paid >= client.amount_due %}
                            <span class="text-green-600 bg-green-50 px-2 py-1 rounded-full text-xs font-medium">ØªÙ… Ø§Ù„Ø¯ÙØ¹</span>
                        {% else %}
                            <span class="text-red-600 bg-red-50 px-2 py-1 rounded-full text-xs font-medium" title="Ø§Ù„Ù…Ø¯ÙÙˆØ¹: {{ client.amount_paid }} / Ø§Ù„Ù…Ø³ØªØ­Ù‚: {{ client.amount_due }}">
                                ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹
                            </span>
                        {% endif %}
                    </td>

                    <!-- Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª -->
                    <td class="px-5 py-3 space-x-2 space-x-reverse whitespace-nowrap">
                        <a href="{{ url_for('client_details', client_id=client.id) }}"
                           class="inline-block text-blue-600 bg-blue-50 hover:bg-blue-100 px-3 py-1 rounded text-sm font-medium">
                            Ø¹Ø±Ø¶
                        </a>
                        <button class="delete-btn inline-block text-red-600 bg-red-50 hover:bg-red-100 px-3 py-1 rounded text-sm font-medium"
                                data-client-id="{{ client.id }}"
                                data-client-name="{{ client.full_name }}">
                            ğŸ—‘ Ø­Ø°Ù
                        </button>

                         <button class="bg-green-500 text-white px-3 py-1 rounded"
                             onclick="openSendModal({{ client.id }}, '{{ client.full_name }}')">
                            Ø¥Ø±Ø³Ø§Ù„  
                        </button>

                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>


    <!-- ğŸ“„ Ø§Ù„ØªØ±Ù‚ÙŠÙ… -->
    {% if total_pages > 1 %}
    <div class="flex flex-wrap items-center justify-between mt-6">
        <a href="{{ url_for('countries') }}"
           class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded">â† Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø¨Ù„Ø¯Ø§Ù†</a>

        <div class="flex gap-1 mt-4 sm:mt-0">
            {% if current_page > 1 %}
            <a href="{{ url_for('clients_by_countries', country_id=country_id, page=current_page-1, search=search, sort_by=sort_by) }}"
               class="px-3 py-2 rounded bg-white hover:bg-blue-100 text-gray-700">Ø§Ù„Ø³Ø§Ø¨Ù‚</a>
            {% endif %}

            {% for i in range(1, total_pages + 1) %}
            <a href="{{ url_for('clients_by_countries', country_id=country_id, page=i, search=search, sort_by=sort_by) }}"
               class="px-3 py-2 rounded {{ 'bg-blue-500 text-white' if i == current_page else 'bg-white hover:bg-blue-100 text-gray-700' }}">
                {{ i }}
            </a>
            {% endfor %}

            {% if current_page < total_pages %}
            <a href="{{ url_for('clients_by_countries', country_id=country_id, page=current_page+1, search=search, sort_by=sort_by) }}"
               class="px-3 py-2 rounded bg-white hover:bg-blue-100 text-gray-700">Ø§Ù„ØªØ§Ù„ÙŠ</a>
            {% endif %}
        </div>
    </div>
    {% endif %}

    {% else %}
        <p class="text-center text-gray-500 mt-6">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù…Ù„Ø§Ø¡ Ù…Ø±ØªØ¨Ø·ÙŠÙ† Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¨Ù„Ø¯.</p>
        <div class="mt-4">
            <a href="{{ url_for('countries') }}"
               class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded">â† Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¨Ù„Ø¯Ø§Ù†</a>
        </div>
    {% endif %}
</div>


<!-- Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ -->
<div id="sendModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white p-6 rounded shadow-lg w-96 relative z-60">
        <h2 class="text-lg font-bold mb-4">Ø¥Ø±Ø³Ø§Ù„ Ø¥Ù„Ù‰ Ø§Ù„ÙˆØ³ÙŠØ·</h2>
        
        <form id="sendToAgentForm" method="post" action="{{ url_for('send_to_agent') }}">
            <input type="hidden" name="client_id" id="modalClientId">
            
            <!-- Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙˆØ³ÙŠØ· -->
            <p class="mb-2 font-semibold">Ø§Ø®ØªØ± Ø§Ù„ÙˆØ³ÙŠØ·:</p>
            <select name="agent_id" class="w-full border p-2 rounded mb-4" required>
                <option value="">-- Ø§Ø®ØªØ± --</option>
                {% for agent in agents %}
                    <option value="{{ agent.id }}">{{ agent.name }}</option>
                {% endfor %}
            </select>
            
            <!-- ØªØ¹Ù„ÙŠÙ‚ -->
            <p class="mb-2 font-semibold">ØªØ¹Ù„ÙŠÙ‚:</p>
            <textarea name="comment" class="w-full border p-2 rounded mb-4" rows="3"></textarea>
            
            <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… -->
            <div class="flex justify-end gap-2">
                <button type="button" onclick="closeSendModal()" class="px-4 py-2 bg-gray-200 rounded">Ø¥Ù„ØºØ§Ø¡</button>
                <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded">Ø¥Ø±Ø³Ø§Ù„</button>
            </div>
        </form>
    </div>
</div>

<!-- Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ -->
<div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-40 hidden z-[999] flex items-center justify-center">
    <div class="w-16 h-16 border-4 border-white border-t-transparent rounded-full animate-spin"></div>
</div>




<script>

 // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
    function openSendModal(clientId, clientName) {
        document.getElementById("modalClientId").value = clientId;
        document.getElementById("sendModal").classList.remove("hidden");
    }

    // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
    function closeSendModal() {
        document.getElementById("sendModal").classList.add("hidden");
    }

    // Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ØŒ Ø£Ø¸Ù‡Ø± Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
    document.getElementById("sendToAgentForm").addEventListener("submit", function() {
        closeSendModal(); // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
        document.getElementById("loadingOverlay").classList.remove("hidden"); // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
    });



    function openSendModal(clientId, clientName) {
    document.getElementById('modalClientId').value = clientId;
    document.getElementById('sendModal').classList.remove('hidden');
    document.getElementById('sendModal').classList.add('flex');
}

function closeSendModal() {
    document.getElementById('sendModal').classList.add('hidden');
    document.getElementById('sendModal').classList.remove('flex');
}



let selectedClientId = null;

function toggleModal(show) {
    const modal = document.getElementById('deleteModal');
    if (show) {
        modal.classList.remove('hidden');
        modal.classList.add('flex');
    } else {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        selectedClientId = null;
    }
}

document.querySelectorAll('.delete-btn').forEach(button => {
    button.addEventListener('click', function () {
        selectedClientId = this.dataset.clientId;
        const clientName = this.dataset.clientName;
        document.getElementById('clientNameToDelete').textContent = clientName;
        toggleModal(true);
    });
});

document.getElementById('confirmDeleteBtn').addEventListener('click', function () {
    if (!selectedClientId) return;

    const deleteBtn = this;
    deleteBtn.disabled = true;
    deleteBtn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­Ø°Ù...';

    fetch(`/delete-client/${selectedClientId}`, {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const clientRow = document.getElementById(`client-${selectedClientId}`);
            if (clientRow) clientRow.remove();
            toggleModal(false);

            // Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø­Ø°Ù
            const toast = document.createElement('div');
            toast.textContent = 'ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­';
            toast.className = 'fixed bottom-6 right-6 bg-green-600 text-white px-4 py-2 rounded shadow-lg';
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        } else {
            alert('ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø­Ø°Ù');
        }
    })
    .catch(error => {
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù');
        console.error(error);
    })
    .finally(() => {
        deleteBtn.disabled = false;
        deleteBtn.textContent = 'Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°Ù';
    });
});



document.getElementById("sendToAgentForm").addEventListener("submit", function() {
    // Show loading overlay
    document.getElementById("loadingOverlay").classList.remove("hidden");
});


</script>



{% endblock %}
